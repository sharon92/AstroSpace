{% extends "base.html" %}
{% block content %}
<!-- Import TailwindCSS and Headless UI via CDN (or use local build pipeline in production) -->
<script src="https://cdn.jsdelivr.net/npm/@headlessui/react@1.7.15/dist/headlessui.umd.js"></script>
<script src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.5/dist/cdn.min.js" defer></script>

<div class="relative flex flex-col items-center justify-center bg-repeat md:bg-cover"
  style="background-image: url('{{ url_for('blog.upload', filename=background_image) }}');">

  <div class="absolute w-full h-full backdrop-blur-md"></div>

  <div class="relative w-0 top-0 h-4 border-1 border-gray-200 dark:border-gray-400">
  </div>

  {% for il in images %}
  <div class="relative flex flex-col items-center justify-center w-full space-y-0 p-2">
    <!-- Title under the date -->
    <h2 class="text-xl text-white text-center">
      {{ il.image.title }}
      {% if il.image.short_description %} - {{ il.image.short_description }}{% endif %}
    </h2>

    <!-- Date -->
    <span class="text-gray-200 font-light text-md">
      {{ il.image.created_at.strftime('%b %Y')|default('No date available') }}
    </span>
  </div>

  <div class="relative w-full md:max-w-4/5 lg:max-w-7/12 px-1 mx-auto">
    <!-- Main Card Container -->
    <div x-data="{ tab: 'image', showObjects: false }"
      class="rounded-xl md:rounded-2xl shadow-xl bg-white/80 dark:bg-gray-800/80 overflow-hidden">

      <!-- Tabs -->
      <div
        class="flex overflow-x-auto border-b border-gray-200 dark:border-gray-700 justify-start md:justify-center items-center whitespace-nowrap">
        {% set tabs = [
            ('image', 'Image'),
            ('lights', 'Lights'),
            ('nights', 'Nights'),
            ('equipment', 'Equipment'),
            ('software', 'Software')
          ] %}

        {% if il.guiding_html %}
        {% set tabs = tabs + [('guiding', 'Guiding')] %}
        {% endif %}
        {% if il.calibration_html %}
        {% set tabs = tabs + [('calibration', 'Calibration')] %}
        {% endif %}

        {% for tab_id, tab_label in tabs %}
        <button @click="tab = '{{ tab_id }}'"
          :class="tab === '{{ tab_id }}' ? 'border-b-2 border-blue-600 text-blue-600 dark:text-blue-400' : 'text-gray-600  dark:text-gray-300'"
          class="px-4 py-2 text-sm font-medium">
          {{ tab_label }}
        </button>
        {% endfor %}
      </div>

      <!-- Image Tab -->
      <div x-show="tab === 'image'" class="space-y-2 md:p-4">
        <div id="zoom-container-{{il.image.id}}"
          class="relative w-full max-w-full overflow-x-auto overflow-y-hidden md:rounded-[10px] flex items-center justify-center group touch-none">

          <div class="relative transition-transform duration-100 ease-in-out origin-center w-full h-full"
            id="zoom-wrapper-{{il.image.id}}">
            <img
              class="object-contain block w-full h-auto origin-center transition-transform duration-100 ease-in-out cursor-grab select-none"
              id="zoomable-image-{{il.image.id}}"
              src="{{ url_for('blog.upload', filename=il.image.image_path|replace('\\', '/')) }}"
              alt="{{ il.image.title }}">
            <div id="svg-overlay-{{il.image.id}}"
              class="absolute top-0 left-0 w-full h-full pointer-events-none z-10 opacity-0 group-hover:opacity-100 transition-opacity duration-300">
            </div>
          </div>

          <!-- Reset Button -->
          <button id="reset-btn-{{il.image.id}}"
            class="absolute bottom-2 right-2 p-1 border-2 opacity-15 border-white rounded-md z-20 bg-gray-200/15 hover:opacity-50 transition"
            aria-label="Reset image zoom" type="button">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64" width="14" height="14" fill="none"
              stroke="white" stroke-width="6">
              <!-- Arrows from center to corners -->
              <line x1="36" y1="28" x2="60" y2="4" />
              <polyline points="38 4 60 4 60 26" />

              <line x1="28" y1="36" x2="4" y2="60" />
              <polyline points="4 38 4 60 26 60 " />

            </svg>
          </button>
        </div>

        <div class="flex justify-between items-center text-sm p-1.5 text-gray-600 dark:text-gray-300">
          <span>
            <span class="hover:text-amber-500 cursor-pointer">@{{ il.image.author }}</span>, <em>üìç
              {{ il.image.location }}</em>
          </span>

          <div class="flex">

            <input id="overlay-toggle-{{il.image.id}}" type="checkbox" class="peer hidden" />

            <label for="overlay-toggle-{{il.image.id}}" class="inline-block p-1.5 rounded-full cursor-pointer border shadow-sm text-sm font-medium 
         transition-colors duration-300
         bg-gray-300 text-gray-900 border-slate-300 
         hover:bg-gray-400 hover:border-slate-500 hover:dark:bg-slate-600 hover:dark:border-slate-400
         peer-checked:hover:bg-green-700 peer-checked:hover:border-green-800
         peer-checked:bg-green-800 peer-checked:text-white peer-checked:border-green-900
         dark:bg-slate-800 dark:text-gray-100 dark:border-slate-600 
         dark:peer-checked:bg-green-500 dark:peer-checked:border-green-300 dark:peer-checked:text-black">
              Annotate
            </label>

          </div>
        </div>

        <div class=" p-2 text-gray-700 dark:text-gray-200">

          <p>{{ il.image.description }}</p>
        </div>
      </div>


      <!-- Acquisition Details Tab -->
      <div x-show="tab === 'lights'" class="p-6 dark:text-white">
        <div class="flex border-b mb-4 w-full overflow-x-auto">
          <table class="table-auto w-full text-left border-collapse">
            <tbody>

              <!-- Filter Row -->
              <tr class="border-b dark:border-gray-700">
                <td class="p-2 font-semibold capitalize">Filter</td>
                {% for light in il.lights %}
                <td class="p-2">
                  <a href="{{ light.filter_link }}" target="_blank"
                    class="text-blue-600 dark:text-blue-400 hover:underline">
                    {{ light.cam_filter|replace("Filter", "") }}
                  </a>
                </td>
                {% endfor %}
              </tr>

              <!-- Other Light Data Rows -->
              {% set rows = {
                'Lights': 'light_count',
                'Single Exposure': 'exposure_time',
                'Total Exposure': 'total_time',
                'Gain': 'gain',
                'Offset': 'offset_cam',
                'Temp (¬∞C)': 'temperature'
              } %}

              {% for label, field in rows.items() %}
              <tr class="border-b dark:border-gray-700">
                <td class="p-2 font-semibold capitalize">{{ label }}</td>
                {% for light in il.lights %}
                <td class="p-2 text-blue-600 dark:text-blue-400">{{ light[field] }}</td>
                {% endfor %}
              </tr>
              {% endfor %}

            </tbody>
          </table>
        </div>
      </div>

      <div x-show="tab === 'nights'" class="p-6 dark:text-white">
        <div class="flex border-b mb-4">
          <table class="table-auto w-full text-left border-collapse">
            <tbody>
              <tr class="border-b dark:border-gray-700">
                <td class="p-2 font-semibold capitalize">Capture Dates</td>
                <td class="p-2 font-semibold capitalize">Moon Illumination</td>
              </tr>
              {% for date in il.dates %}
              <tr class="border-b dark:border-gray-700">
                <td class="p-2 font-semibold capitalize">{{ date.capture_date }}</td>
                <td class="p-2 text-blue-600 dark:text-blue-400"">{{ date.moon_phase }} ({{ date.moon_illumination }}%)</td>
            </tr>
            {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

      <div x-show=" tab==='equipment'" class=" p-6 dark:text-white">
                  <div class="flex border-b mb-4">
                    <table class="table-auto w-full text-left border-collapse">
                      <tbody>
                        {% for equipment in il.equipment_list %}
                        <tr class="border-b dark:border-gray-700">
                          <td class="p-2 font-semibold capitalize">
                            {{ equipment.table|replace('_', ' ') + ":" }}
                          </td>
                          <td class="p-2">
                            <a href="{{ equipment.link }}" target="_blank"
                              class="text-blue-600 dark:text-blue-400 hover:underline">
                              {{ equipment.brand | default('') + " " + equipment.name|replace(equipment.brand | default(''), '') }}
                            </a>
                          </td>
                        </tr>
                        {% endfor %}
                      </tbody>
                    </table>
                  </div>
        </div>

        <div x-show="tab === 'software'" class="p-6 dark:text-white">
          <div class="flex border-b mb-4">
            <table class="table-auto w-full text-left border-collapse">
              <tbody>
                <tr class="border-b dark:border-gray-700">
                  <td class="p-2 font-semibold capitalize">Acquisition</td>
                  <td class="p-2 text-blue-600 dark:text-blue-400">
                    {% for software in il.software_list %}
                    {% if software.type == 'acquisition' %}
                    <p><a href="{{ software.link }}" target="_blank">{{ software.name }}</a>
                    </p>
                    {% endif %}
                    {% endfor %}
                  </td>
                </tr>
                <tr class="border-b dark:border-gray-700">
                  <td class="p-2 font-semibold capitalize">Processing</td>
                  <td class="p-2 text-blue-600 dark:text-blue-400">
                    {% for software in il.software_list %}
                    {% if software.type == 'processing' %}
                    {% if software.metadata %}
                    <p>{{ software.metadata | safe}}</p>
                    {% else %}
                    <p><a href="{{ software.link }}" target="_blank">{{ software.name }}</a></p>
                    {% endif %}
                    {% endif %}
                    {% endfor %}
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Guiding Tab -->
        <div x-show="tab === 'guiding'" class="p-6">
          <!-- Bokeh Graph Embed -->
          <div class="p-4 rounded-lg shadow-lg dark:bg-gray-800 mb-6">

            {{il.guiding_html | safe}}

          </div>
        </div>

        <div x-show="tab === 'calibration'" class="p-6">
          <!-- Bokeh Graph Embed -->
          <div class="p-4 rounded-lg shadow-lg items-center dark:bg-gray-800 mb-6">

            {{il.calibration_html | safe}}

          </div>
        </div>

      </div>

      <div class="relative flex flex-col items-center justify-center">
        <div class="relative w-0 top-0 h-6 border-1 mt-2 border-gray-200 dark:border-gray-400">
        </div>
      </div>

      <style>
        [x-cloak] {
          display: none;
        }
      </style>

      <script>
        (function () {
          const img = document.getElementById('zoomable-image-{{il.image.id}}');
          const wrapper = document.getElementById('zoom-wrapper-{{il.image.id}}');

          let scale = 1;
          let originX = 0;
          let originY = 0;
          let isPanning = false;
          let startX, startY;

          // Desktop Zoom (scroll)
          wrapper.addEventListener('wheel', e => {
            e.preventDefault();
            const scaleAmount = e.deltaY > 0 ? 0.9 : 1.1;
            scale *= scaleAmount;
            updateTransform();
          });

          // Desktop Pan (mouse)
          wrapper.addEventListener('mousedown', e => {
            isPanning = true;
            startX = e.clientX - originX;
            startY = e.clientY - originY;
            img.style.cursor = 'grabbing';
          });

          document.addEventListener('mousemove', e => {
            if (!isPanning) return;
            originX = e.clientX - startX;
            originY = e.clientY - startY;
            updateTransform();
          });

          document.addEventListener('mouseup', () => {
            isPanning = false;
            img.style.cursor = 'grab';
          });

          // Mobile: Pan and Pinch
          let lastDist = null;
          wrapper.addEventListener('touchstart', e => {
            if (e.touches.length === 1) {
              startX = e.touches[0].clientX - originX;
              startY = e.touches[0].clientY - originY;
            }
          });

          wrapper.addEventListener('touchmove', e => {
            if (e.touches.length === 1) {
              originX = e.touches[0].clientX - startX;
              originY = e.touches[0].clientY - startY;
            } else if (e.touches.length === 2) {
              const [a, b] = e.touches;
              const dist = Math.hypot(b.clientX - a.clientX, b.clientY - a.clientY);
              if (lastDist) {
                const scaleFactor = dist / lastDist;
                scale *= scaleFactor;
              }
              lastDist = dist;
            }
            updateTransform();
          });

          wrapper.addEventListener('touchend', e => {
            if (e.touches.length < 2) {
              lastDist = null;
            }
          });

          function updateTransform() {
            wrapper.style.transform = `translate(${originX}px, ${originY}px) scale(${scale})`;
          }

          document.getElementById('reset-btn-{{il.image.id}}').addEventListener('click', () => {
            scale = 1;
            originX = 0;
            originY = 0;
            updateTransform();
          });

          const overlayToggle = document.getElementById('overlay-toggle-{{il.image.id}}');
          const svgOverlay = document.getElementById('svg-overlay-{{il.image.id}}');

          let overlayData = {{ il.svg_image | tojson | safe
        }};

        function renderOverlay() {
          if (!overlayToggle.checked) {
            svgOverlay.innerHTML = "";
            return;
          }

          let svg = `<svg viewBox="0 0 ${overlayData.width} ${overlayData.height}" preserveAspectRatio="xMidYMid meet" style="position: absolute; top: 0; left: 0; pointer-events: auto;">`;

          for (let [otype, items] of Object.entries(overlayData.overlays)) {
            for (let item of items) {
              if (item.rx >= 10 && item.ry >= 10) {
                const transform = item.angle && item.angle !== 32767
                  ? ` transform="rotate(${item.angle}, ${item.x.toFixed(2)}, ${item.y.toFixed(2)})"`
                  : "";
                svg += `<ellipse cx="${item.x.toFixed(2)}" cy="${item.y.toFixed(2)}"
                      rx="${item.rx.toFixed(2)}" ry="${item.ry.toFixed(2)}"${transform}
                      fill="none" stroke="white" stroke-opacity="0.9" stroke-width="10" style="pointer-events: all;"></ellipse>
                    <text x="${(item.x + 60).toFixed(2)}" y="${(item.y - item.ry - 40).toFixed(2)}"
                          font-size="72" fill="white" stroke="black" stroke-width="2"
                          text-anchor="middle" alignment-baseline="middle">
                      ${item.id}
                    </text>`;
              }
            }
          }
          svg += "</svg>";
          svgOverlay.innerHTML = svg;
        }

        // Handle overlay toggle
        overlayToggle.addEventListener('change', () => {
          renderOverlay();
        });

        renderOverlay();

        document.addEventListener("DOMContentLoaded", () => {
          const zoomContainer = document.getElementById("zoom-container-{{il.image.id}}");
          const svgOverlay = document.getElementById("svg-overlay-{{il.image.id}}");

          let overlayVisible = false;

          zoomContainer.addEventListener("touchstart", () => {
            overlayVisible = !overlayVisible;
            svgOverlay.classList.toggle("opacity-100", overlayVisible);
            svgOverlay.classList.toggle("opacity-0", !overlayVisible);
          });
        });
  }) ();
      </script>


    </div>
    {% endfor %}
    <div class="relative min-h-[35vh] flex flex-col items-center justify-center shadow-5xl">
      <div
        class="flex-grow flex items-center justify-center border-1 border-gray-200 dark:border-gray-400   shadow-5xl">
        <div class="w-0 top-0 h-full shadow-2xl">
        </div>
      </div>
    </div>
  </div>
  {% endblock %}